#!/usr/bin/env bash
set -euo pipefail

remote_name="${1:-}"
remote_url="${2:-}"

TARGET_BRANCH="${SHIP_BRANCH:-main}"
UPSTREAM_REMOTE="${SHIP_UPSTREAM_REMOTE:-upstream}"

# Only enforce when pushing local main -> remote main.
enforce=false
while IFS=' ' read -r local_ref local_sha remote_ref remote_sha; do
	if [[ "$local_ref" == "refs/heads/$TARGET_BRANCH" && "$remote_ref" == "refs/heads/$TARGET_BRANCH" ]]; then
		enforce=true
	fi
done

if [[ "$enforce" != "true" ]]; then
	exit 0
fi

if ! git remote get-url "$UPSTREAM_REMOTE" >/dev/null 2>&1; then
	echo "pre-push: missing upstream remote '$UPSTREAM_REMOTE'." >&2
	echo "pre-push: configure upstream, then run ./scripts/ship-main.sh" >&2
	exit 1
fi

if ! git fetch "$UPSTREAM_REMOTE" "$TARGET_BRANCH" --prune >/dev/null 2>&1; then
	echo "pre-push: failed to fetch $UPSTREAM_REMOTE/$TARGET_BRANCH" >&2
	exit 1
fi

if ! git merge-base --is-ancestor "$UPSTREAM_REMOTE/$TARGET_BRANCH" "$TARGET_BRANCH"; then
	echo "pre-push: $TARGET_BRANCH is not rebased on $UPSTREAM_REMOTE/$TARGET_BRANCH" >&2
	echo "pre-push: run ./scripts/ship-main.sh and retry." >&2
	exit 1
fi

# shellcheck disable=SC2034
_="$remote_name"
# shellcheck disable=SC2034
_="$remote_url"
